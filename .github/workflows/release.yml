name: Release con artefactos

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag de la release (vX.Y.Z)"
        required: true
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  create-release:
    name: Crear release
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve-tag.outputs.tag || steps.resolve-tag-push.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolver tag
        id: resolve-tag
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"

      - name: Resolver tag (push)
        id: resolve-tag-push
        if: ${{ github.event_name != 'workflow_dispatch' }}
        run: |
          echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: Crear release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.resolve-tag.outputs.tag || steps.resolve-tag-push.outputs.tag }}"
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "Release ya existe, se reutiliza."
          else
            gh release create "$TAG" \
              --title "$TAG" \
              --generate-notes
          fi

  windows:
    name: Windows MSI/MSIX
    runs-on: windows-latest
    needs: create-release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Preparar MSIX firmado (opcional)
        shell: pwsh
        env:
          WIN_MSIX_PFX_BASE64: ${{ secrets.WIN_MSIX_PFX_BASE64 }}
          WIN_MSIX_PFX_PASSWORD: ${{ secrets.WIN_MSIX_PFX_PASSWORD }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:WIN_MSIX_PFX_BASE64)) {
            Write-Host "Sin WIN_MSIX_PFX_BASE64, se omite firma MSIX."
            exit 0
          }
          $pfxPath = Join-Path $env:RUNNER_TEMP "msix_signing.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WIN_MSIX_PFX_BASE64))
          "SIGN_CERT_PFX=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "SIGN_CERT_PASSWORD=$env:WIN_MSIX_PFX_PASSWORD" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Crear MSIX
        shell: pwsh
        run: powershell -ExecutionPolicy Bypass -File .\scripts\create-windows-msix.ps1

      - name: Crear MSI
        shell: pwsh
        run: powershell -ExecutionPolicy Bypass -File .\scripts\create-windows-msi.ps1

      - name: Validar y empaquetar artefactos Windows
        shell: pwsh
        run: |
          $msi = Get-ChildItem artifacts\msi\*.msi -ErrorAction SilentlyContinue
          if (-not $msi) { Write-Error "No se encontraron .msi en artifacts\\msi"; exit 1 }
          $cab = Get-ChildItem artifacts\msi\*.cab -ErrorAction SilentlyContinue

          $msix = Get-ChildItem artifacts\msix\*.msix -ErrorAction SilentlyContinue
          if (-not $msix) { Write-Error "No se encontraron .msix en artifacts\\msix"; exit 1 }
          $cer = Get-ChildItem artifacts\msix\*.cer -ErrorAction SilentlyContinue

          $msiZipPath = Join-Path "artifacts\\msi" ($msi[0].BaseName + "_msi.zip")
          $msiFiles = @($msi.FullName)
          if ($cab) { $msiFiles += $cab.FullName }
          Compress-Archive -Path $msiFiles -DestinationPath $msiZipPath -Force

          $msixZipPath = Join-Path "artifacts\\msix" ($msix[0].BaseName + "_msix.zip")
          $msixFiles = @($msix.FullName)
          if ($cer) { $msixFiles += $cer.FullName }
          Compress-Archive -Path $msixFiles -DestinationPath $msixZipPath -Force

      - name: Subir artefactos Windows
        env:
          GH_TOKEN: ${{ github.token }}
        shell: pwsh
        run: |
          $upload = @()
          $upload += Get-ChildItem artifacts\msi\*.msi | ForEach-Object { $_.FullName }
          $upload += Get-ChildItem artifacts\msix\*.msix | ForEach-Object { $_.FullName }
          $cab = Get-ChildItem artifacts\msi\*.cab -ErrorAction SilentlyContinue | ForEach-Object { $_.FullName }
          if ($cab) { $upload += $cab }
          $cer = Get-ChildItem artifacts\msix\*.cer -ErrorAction SilentlyContinue | ForEach-Object { $_.FullName }
          if ($cer) { $upload += $cer }
          $upload += Get-ChildItem artifacts\msi\*_msi.zip | ForEach-Object { $_.FullName }
          $upload += Get-ChildItem artifacts\msix\*_msix.zip | ForEach-Object { $_.FullName }
          if ($upload.Count -eq 0) { Write-Error "No hay artefactos Windows para subir."; exit 1 }
          gh release upload "${{ needs.create-release.outputs.tag }}" $upload --clobber

  macos:
    name: macOS DMG
    runs-on: macos-latest
    needs: create-release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Publicar DMG
        run: ./scripts/publish-macos.sh --project src/OfertaDemanda.Desktop/OfertaDemanda.Desktop.csproj --config Release

      - name: Subir artefactos macOS
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ needs.create-release.outputs.tag }}" artifacts/*.dmg --clobber

  linux:
    name: Linux publish
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Publicar Linux
        run: dotnet publish src/OfertaDemanda.Desktop/OfertaDemanda.Desktop.csproj -c Release -r linux-x64 --self-contained true -p:UseAppHost=true -o artifacts/publish/linux-x64

      - name: Empaquetar Linux
        run: |
          tar -czf artifacts/OfertaDemanda.Desktop-linux-x64.tar.gz -C artifacts/publish/linux-x64 .

      - name: Subir artefactos Linux
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ needs.create-release.outputs.tag }}" artifacts/OfertaDemanda.Desktop-linux-x64.tar.gz --clobber
