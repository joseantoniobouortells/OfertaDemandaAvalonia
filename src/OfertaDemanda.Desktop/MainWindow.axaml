<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
        xmlns:views="using:OfertaDemanda.Desktop.Views"
        mc:Ignorable="d"
        x:Class="OfertaDemanda.Desktop.MainWindow"
        Width="1200"
        Height="800"
        Title="Oferta vs Demanda"
        Icon="avares://OfertaDemanda.Desktop/Assets/icon_1024.png"
        x:CompileBindings="False">
    <Grid RowDefinitions="Auto,*" Margin="16">
        <StackPanel Orientation="Horizontal"
                    HorizontalAlignment="Stretch"
                    Margin="0,0,0,12">
            <TextBlock Text="Oferta, demanda y elasticidades"
                       FontSize="22"
                       FontWeight="Bold" />
            <Button Content="Restablecer valores por defecto"
                    Command="{Binding ResetDefaultsCommand}"
                    Margin="16,0,0,0" />
        </StackPanel>

        <TabControl Grid.Row="1"
                    TabStripPlacement="Top">
            <TabItem Header="Mercado">
                <Grid ColumnDefinitions="340,*"
                      ColumnSpacing="16"
                      DataContext="{Binding Market}">
                    <ScrollViewer Grid.Column="0"
                                  VerticalScrollBarVisibility="Auto">
                        <StackPanel Spacing="12">
                            <TextBlock Text="Funciones"
                                       FontWeight="Bold" />
                            <TextBlock Text="Demanda inversa Pd(q)" />
                            <TextBox Text="{Binding DemandExpression, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock Text="Oferta inversa Ps(q)"
                                       Margin="0,8,0,0" />
                            <TextBox Text="{Binding SupplyExpression, UpdateSourceTrigger=PropertyChanged}" />

                            <TextBlock Text="Shocks e impuesto"
                                       FontWeight="Bold"
                                       Margin="0,16,0,0" />
                            <TextBlock Text="Shock demanda ΔD" />
                            <Slider Minimum="-30"
                                    Maximum="30"
                                    Value="{Binding DemandShock}"
                                    TickFrequency="5" />
                            <TextBlock Text="{Binding DemandShock, StringFormat='Valor actual: {0:F0}'}"
                                       FontSize="12" />

                            <TextBlock Text="Shock oferta ΔS"
                                       Margin="0,8,0,0" />
                            <Slider Minimum="-30"
                                    Maximum="30"
                                    Value="{Binding SupplyShock}"
                                    TickFrequency="5" />
                            <TextBlock Text="{Binding SupplyShock, StringFormat='Valor actual: {0:F0}'}"
                                       FontSize="12" />

                            <TextBlock Text="Impuesto unitario t"
                                       Margin="0,8,0,0" />
                            <Slider Minimum="0"
                                    Maximum="30"
                                    Value="{Binding Tax}"
                                    TickFrequency="5" />
                            <TextBlock Text="{Binding Tax, StringFormat='Valor actual: {0:F0}'}"
                                       FontSize="12" />

                            <TextBlock Text="Costes"
                                       FontWeight="Bold"
                                       Margin="0,16,0,0" />
                            <TextBlock Text="Tipo de función" />
                            <ComboBox ItemsSource="{Binding CostTypeOptions}"
                                      SelectedItem="{Binding SelectedCostType}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Label}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                            <TextBlock Text="Coste fijo F"
                                       Margin="0,8,0,0" />
                            <TextBox Text="{Binding FixedCost, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock Text="Coste lineal a"
                                       Margin="0,8,0,0" />
                            <TextBox Text="{Binding LinearCost, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock Text="Coste cuadrático b"
                                       Margin="0,8,0,0" />
                            <TextBox Text="{Binding QuadraticCost, UpdateSourceTrigger=PropertyChanged}" />
                            <StackPanel IsVisible="{Binding IsCubicCostVisible}">
                                <TextBlock Text="Coste cúbico c"
                                           Margin="0,8,0,0" />
                                <TextBox Text="{Binding CubicCost, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>

                            <TextBlock Text="Curvas y elementos"
                                       FontWeight="Bold"
                                       Margin="0,12,0,0" />
                            <StackPanel Orientation="Horizontal"
                                        Spacing="8">
                                <Button Content="Mostrar todo"
                                        Command="{Binding ShowAllTogglesCommand}" />
                                <Button Content="Ocultar todo"
                                        Command="{Binding HideAllTogglesCommand}" />
                            </StackPanel>
                            <ItemsControl ItemsSource="{Binding ToggleGroups}"
                                          Margin="0,6,0,0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Margin="0,8,0,0">
                                            <StackPanel Orientation="Horizontal"
                                                        Spacing="8">
                                                <TextBlock Text="{Binding Label}"
                                                           FontWeight="SemiBold" />
                                                <Button Content="Mostrar grupo"
                                                        Command="{Binding DataContext.ShowGroupCommand, RelativeSource={RelativeSource AncestorType=ScrollViewer}}"
                                                        CommandParameter="{Binding}" />
                                            </StackPanel>
                                            <ItemsControl ItemsSource="{Binding Items}"
                                                          Margin="0,4,0,0">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <CheckBox Content="{Binding Label}"
                                                                  IsChecked="{Binding IsVisible}" />
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <TextBlock Text="Resultados"
                                       FontWeight="Bold"
                                       Margin="0,16,0,0" />
                            <WrapPanel>
                                <TextBlock Text="{Binding EquilibriumText}" />
                                <TextBlock Text="{Binding PriceConsumerText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding PriceProducerText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding ConsumerSurplusText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding ProducerSurplusText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding TaxRevenueText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding DeadweightLossText}" Margin="8,0,0,0" />
                            </WrapPanel>

                            <TextBlock Text="Firma competitiva"
                                       FontWeight="Bold"
                                       Margin="0,12,0,0" />
                            <WrapPanel>
                                <TextBlock Text="{Binding FirmQuantityText}" />
                                <TextBlock Text="{Binding FirmMarginalCostText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding FirmAverageVariableCostText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding FirmAverageCostText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding FirmProfitText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding FirmStateText}" Margin="8,0,0,0" />
                            </WrapPanel>

                            <Border Margin="0,12,0,0"
                                    Padding="10"
                                    CornerRadius="6"
                                    Background="{DynamicResource ThemeControlLowBrush}">
                                <StackPanel>
                                    <TextBlock Text="Explicación"
                                               FontWeight="SemiBold"
                                               Margin="0,0,0,6" />
                                    <StackPanel Margin="0,4,0,0">
                                        <TextBlock Text="MC(q) = dC/dq"
                                                   FontWeight="SemiBold" />
                                        <TextBlock Text="Costo marginal en competencia perfecta: MR = P."
                                                   FontSize="12"
                                                   Opacity="0.75" />
                                    </StackPanel>
                                    <StackPanel Margin="0,6,0,0">
                                        <TextBlock Text="AVC(q) = VC(q)/q"
                                                   FontWeight="SemiBold" />
                                        <TextBlock Text="Cierre si P &lt; min AVC."
                                                   FontSize="12"
                                                   Opacity="0.75" />
                                    </StackPanel>
                                    <StackPanel Margin="0,6,0,0">
                                        <TextBlock Text="AC(q) = C(q)/q"
                                                   FontWeight="SemiBold" />
                                        <TextBlock Text="Beneficio si P > AC(q_f*), pérdida si P &lt; AC(q_f*)."
                                                   FontSize="12"
                                                   Opacity="0.75" />
                                    </StackPanel>
                                    <StackPanel Margin="0,6,0,0">
                                        <TextBlock Text="π(q) = Pq − C(q)"
                                                   FontWeight="SemiBold" />
                                        <TextBlock Text="Área sombreada muestra beneficio o pérdida al q_f*."
                                                   FontSize="12"
                                                   Opacity="0.75" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <Border Margin="0,12,0,0"
                                    Padding="8"
                                    Background="#3FFFF0F0"
                                    CornerRadius="4"
                                    IsVisible="{Binding HasErrors}">
                                <StackPanel>
                                    <TextBlock Text="Errores"
                                               FontWeight="Bold" />
                                    <ItemsControl ItemsSource="{Binding Errors}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="• {Binding}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>

                    <lvc:CartesianChart Grid.Column="1"
                                        Series="{Binding Series}"
                                        XAxes="{Binding XAxes}"
                                        YAxes="{Binding YAxes}"
                                        LegendPosition="Right" />
                </Grid>
            </TabItem>

            <TabItem Header="Empresa">
                <Grid ColumnDefinitions="340,*"
                      ColumnSpacing="16"
                      DataContext="{Binding Firm}">
                    <ScrollViewer Grid.Column="0"
                                  VerticalScrollBarVisibility="Auto">
                        <StackPanel Spacing="12">
                            <TextBlock Text="Costes y modo"
                                       FontWeight="Bold" />
                            <TextBlock Text="CT(q)" />
                            <TextBox Text="{Binding CostExpression, UpdateSourceTrigger=PropertyChanged}" />

                            <TextBlock Text="Modo de operación"
                                       Margin="0,8,0,0" />
                            <ComboBox ItemsSource="{Binding ModeOptions}"
                                      SelectedItem="{Binding SelectedMode}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Label}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>

                            <TextBlock Text="Precio del mercado (CP)"
                                       Margin="0,8,0,0" />
                            <Slider Minimum="10"
                                    Maximum="100"
                                    Value="{Binding Price}"
                                    IsEnabled="{Binding IsPriceEditable}" />
                            <TextBlock Text="{Binding Price, StringFormat='Valor actual: {0:F0}'}"
                                       FontSize="12" />

                            <TextBlock Text="Resultados"
                                       FontWeight="Bold"
                                       Margin="0,16,0,0" />
                            <WrapPanel>
                                <TextBlock Text="{Binding QuantityText}" />
                                <TextBlock Text="{Binding PriceText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding ProfitText}" Margin="8,0,0,0" />
                            </WrapPanel>

                            <Border Margin="0,12,0,0"
                                    Padding="8"
                                    Background="#3FFFF0F0"
                                    CornerRadius="4"
                                    IsVisible="{Binding HasErrors}">
                                <StackPanel>
                                    <TextBlock Text="Errores"
                                               FontWeight="Bold" />
                                    <ItemsControl ItemsSource="{Binding Errors}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="• {Binding}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>

                    <lvc:CartesianChart Grid.Column="1"
                                        Series="{Binding Series}"
                                        XAxes="{Binding XAxes}"
                                        YAxes="{Binding YAxes}"
                                        LegendPosition="Right" />
                </Grid>
            </TabItem>

            <TabItem Header="Monopolio">
                <Grid ColumnDefinitions="340,*"
                      ColumnSpacing="16"
                      DataContext="{Binding Monopoly}">
                    <ScrollViewer Grid.Column="0"
                                  VerticalScrollBarVisibility="Auto">
                        <StackPanel Spacing="12">
                            <TextBlock Text="Demanda inversa Pd(q)"
                                       FontWeight="Bold" />
                            <TextBox Text="{Binding DemandExpression, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock Text="Coste total CT(q)"
                                       Margin="0,8,0,0" />
                            <TextBox Text="{Binding CostExpression, UpdateSourceTrigger=PropertyChanged}" />

                            <TextBlock Text="Resultados"
                                       FontWeight="Bold"
                                       Margin="0,16,0,0" />
                            <WrapPanel>
                                <TextBlock Text="{Binding MonopolyQuantityText}" />
                                <TextBlock Text="{Binding MonopolyPriceText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding ProfitText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding CompetitiveQuantityText}" Margin="8,0,0,0" />
                                <TextBlock Text="{Binding DeadweightLossText}" Margin="8,0,0,0" />
                            </WrapPanel>

                            <Border Margin="0,12,0,0"
                                    Padding="8"
                                    Background="#3FFFF0F0"
                                    CornerRadius="4"
                                    IsVisible="{Binding HasErrors}">
                                <StackPanel>
                                    <TextBlock Text="Errores"
                                               FontWeight="Bold" />
                                    <ItemsControl ItemsSource="{Binding Errors}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="• {Binding}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>

                    <lvc:CartesianChart Grid.Column="1"
                                        Series="{Binding Series}"
                                        XAxes="{Binding XAxes}"
                                        YAxes="{Binding YAxes}"
                                        LegendPosition="Right" />
                </Grid>
            </TabItem>

            <TabItem Header="Elasticidad">
                <Grid ColumnDefinitions="340,*"
                      ColumnSpacing="16"
                      DataContext="{Binding Elasticity}">
                    <ScrollViewer Grid.Column="0"
                                  VerticalScrollBarVisibility="Auto">
                        <StackPanel Spacing="12">
                            <TextBlock Text="Se usa la demanda base del mercado"
                                       FontWeight="Bold" />
                            <TextBlock Text="Demanda Pd(q)" />
                            <TextBox Text="{Binding Market.DemandExpression, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock Text="{Binding Market.DemandShock, StringFormat='Shock ΔD actual: {0:F0}'}"
                                       FontSize="12" />

                            <TextBlock Text="Precio para elasticidad"
                                       Margin="0,12,0,0" />
                            <Slider Minimum="10"
                                    Maximum="110"
                                    Value="{Binding Price}" />
                            <TextBlock Text="{Binding Price, StringFormat='Precio actual: {0:F0}'}"
                                       FontSize="12" />

                            <TextBlock Text="{Binding ElasticityText}"
                                       Margin="0,12,0,0" />

                            <Border Margin="0,12,0,0"
                                    Padding="8"
                                    Background="#3FFFF0F0"
                                    CornerRadius="4"
                                    IsVisible="{Binding HasErrors}">
                                <StackPanel>
                                    <TextBlock Text="Errores"
                                               FontWeight="Bold" />
                                    <ItemsControl ItemsSource="{Binding Errors}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="• {Binding}" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>

                    <lvc:CartesianChart Grid.Column="1"
                                        Series="{Binding Series}"
                                        XAxes="{Binding XAxes}"
                                        YAxes="{Binding YAxes}"
                                        LegendPosition="Right" />
                </Grid>
            </TabItem>

            <TabItem Header="Isobeneficio">
                <views:IsoBenefitView DataContext="{Binding IsoBenefit}" />
            </TabItem>

            <TabItem Header="Configuración">
                <views:SettingsView DataContext="{Binding Settings}" />
            </TabItem>
        </TabControl>
    </Grid>
</Window>
